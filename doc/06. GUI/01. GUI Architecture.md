# GUI Architecture - My Personal Map

Documentazione completa dell'architettura GUI desktop con CustomTkinter.

---

## Indice

- [Panoramica](#panoramica)
- [Struttura Componenti](#struttura-componenti)
- [Theme System](#theme-system)
- [Layout System](#layout-system)
- [Backend Integration](#backend-integration)
- [Database Setup Wizard](#database-setup-wizard)

---

## Panoramica

La GUI di My Personal Map Ã¨ costruita con **CustomTkinter**, un framework moderno per Python che estende Tkinter con un'interfaccia moderna e supporto dark mode nativo.

### Architettura a Livelli

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Application Layer               â”‚
â”‚         (app.py)                        â”‚
â”‚  - Window Management                    â”‚
â”‚  - Lifecycle Events                     â”‚
â”‚  - Backend Coordination                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Layout Layer                    â”‚
â”‚         (layouts/)                      â”‚
â”‚  - MainLayout (Sidebar + Content)       â”‚
â”‚  - Responsive Design                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Component Layer                 â”‚
â”‚         (components/)                   â”‚
â”‚  - CustomButton                         â”‚
â”‚  - Sidebar, MapViewer, etc.            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Theme Layer                     â”‚
â”‚         (theme.py, themes/*.json)       â”‚
â”‚  - Colors, Fonts, Spacing              â”‚
â”‚  - Dark/Light Mode                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Struttura Componenti

### Directory Organization

```
pymypersonalmap/gui/
â”œâ”€â”€ app.py                    # Entry point principale
â”œâ”€â”€ theme.py                  # Theme configuration
â”œâ”€â”€ backend_manager.py        # FastAPI thread manager
â”œâ”€â”€ config_manager.py         # OS-specific configuration
â”œâ”€â”€ setup_wizard.py           # Database setup wizard
â”‚
â”œâ”€â”€ themes/
â”‚   â””â”€â”€ mypersonalmap_theme.json  # CustomTkinter theme
â”‚
â”œâ”€â”€ components/               # Componenti UI riutilizzabili
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ custom_button.py     # Bottoni con varianti
â”‚   â”œâ”€â”€ custom_sidebar.py    # Navigation sidebar
â”‚   â””â”€â”€ map_viewer.py        # Folium map embedded
â”‚
â”œâ”€â”€ layouts/                  # Layout completi
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ main_layout.py       # Layout principale app
â”‚
â””â”€â”€ assets/                   # Risorse statiche
    â”œâ”€â”€ icon.ico             # Windows icon
    â”œâ”€â”€ icon.icns            # macOS icon
    â””â”€â”€ icon.png             # Linux icon
```

---

## Theme System

### File di Configurazione

**Location**: `pymypersonalmap/gui/themes/mypersonalmap_theme.json`

Il theme JSON definisce colori e stili per tutti i widget CustomTkinter:

```json
{
  "CTk": {
    "fg_color": ["#F9FAFB", "#0F172A"]  // [light, dark]
  },
  "CTkButton": {
    "fg_color": ["#4F46E5", "#4F46E5"],
    "hover_color": ["#3730A3", "#3730A3"],
    "text_color": ["#FFFFFF", "#FFFFFF"]
  }
}
```

### Theme Manager

**Location**: `pymypersonalmap/gui/theme.py`

Fornisce:
- **Colori**: Palette completa dal design system
- **Fonts**: Font families, sizes, weights
- **Spacing**: Scala basata su 4px
- **Helper functions**: `get_font()`, `get_color()`, `init_theme()`

#### Utilizzo

```python
from pymypersonalmap.gui.theme import init_theme, get_font, COLORS

# Inizializza tema
init_theme(mode="dark")  # o "light"

# Usa colori
button.configure(fg_color=COLORS["primary"])

# Usa font
label.configure(font=get_font("sans", "2xl", "bold"))
```

### Color Palette

Colori principali dal design system:

| Nome | Hex | Uso |
|------|-----|-----|
| **primary** | `#4F46E5` | Brand color, azioni principali |
| **accent** | `#F59E0B` | CTA, highlights, markers |
| **success** | `#10B981` | Conferme, successi |
| **warning** | `#F59E0B` | Avvisi |
| **error** | `#EF4444` | Errori |

---

## Layout System

### MainLayout

**Location**: `pymypersonalmap/gui/layouts/main_layout.py`

Layout principale dell'applicazione con:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         â”‚  â”‚     Top Bar (64px)   â”‚  â”‚
â”‚  â”‚ Sidebar â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ (280px) â”‚  â”‚                      â”‚  â”‚
â”‚  â”‚         â”‚  â”‚   Main Content       â”‚  â”‚
â”‚  â”‚         â”‚  â”‚   (MapViewer)        â”‚  â”‚
â”‚  â”‚         â”‚  â”‚                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Struttura

```python
class MainLayout(ctk.CTkFrame):
    def __init__(self, master):
        # Sidebar fissa 280px
        self.sidebar = Sidebar(self, width=280)

        # Content area (expand)
        self.content_area = ctk.CTkFrame(self)

        # Top bar 64px
        self.topbar = self._create_topbar()

        # Main content (mappa)
        self.map_viewer = MapViewer(self.main_content)
```

#### Metodi Chiave

- `show_map()`: Mostra vista mappa
- `show_list()`: Mostra vista lista (to implement)

---

## Backend Integration

### BackendManager

**Location**: `pymypersonalmap/gui/backend_manager.py`

Gestisce FastAPI in un thread daemon separato.

#### Architettura

```python
class BackendManager:
    def start(self):
        """Avvia FastAPI in thread daemon"""

    def wait_for_ready(self, timeout=10):
        """Polling /health endpoint"""

    def is_healthy(self) -> bool:
        """Check salute backend"""

    def get_base_url(self) -> str:
        """URL base per requests"""
```

#### Utilizzo nell'App

```python
# In app.py
self.backend = BackendManager(host="127.0.0.1", port=8000)
self.backend.start()  # Avvia in background

# Verifica salute
if self.backend.is_healthy():
    print("Backend ready!")
```

#### Comunicazione GUI â†’ Backend

```python
import requests

# Ottieni base URL dal manager
base_url = self.backend.get_base_url()

# Fai richieste
response = requests.get(f"{base_url}/api/v1/markers")
markers = response.json()
```

---

## Database Setup Wizard

### DatabaseSetupWizard

**Location**: `pymypersonalmap/gui/setup_wizard.py`

Wizard interattivo per configurazione database al primo avvio.

#### Flow del Wizard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Welcome   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check MySQL    â”‚â—„â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
     â”‚                   â”‚
     â”œâ”€ MySQL Found â”€â”€â”€â”€â–ºâ”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚   â”‚ Setup Form   â”‚â”‚
     â”‚   â”‚ - Root pwd   â”‚â”‚
     â”‚   â”‚ - Create DB  â”‚â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â”‚          â”‚        â”‚
     â”‚          â–¼        â”‚
     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚   â”‚   Success    â”‚â”‚
     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â”‚                   â”‚
     â””â”€ MySQL NOT Found â”˜
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Options:    â”‚
         â”‚ 1. Guide     â”‚â—„â”€â”
         â”‚ 2. SQLite    â”‚  â”‚ Retry
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                   â”‚       â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Steps Implementati

1. **Welcome Screen**: Introduzione
2. **MySQL Check**: Rileva MySQL installato
3. **If MySQL Found**:
   - Form credenziali root
   - Creazione automatica DB/user
   - Aggiornamento `.env`
4. **If MySQL NOT Found**:
   - Guida installazione OS-specific
   - Fallback SQLite con warning limitazioni

#### Utilizzo

```python
# In app.py
if not self.check_database_configured():
    wizard = DatabaseSetupWizard(self, on_complete=self.on_wizard_complete)
    self.wait_window(wizard)
```

---

## Componenti Principali

### CustomButton

**Location**: `pymypersonalmap/gui/components/custom_button.py`

Bottone con varianti stilistiche.

#### Varianti

- **primary**: Azione principale (blu)
- **secondary**: Azione secondaria (outline)
- **accent**: Call-to-action (arancione)
- **success**: Conferme (verde)
- **error**: Azioni distruttive (rosso)

#### Esempio

```python
from pymypersonalmap.gui.components import CustomButton

# Primary button
btn_primary = CustomButton(
    parent,
    text="Salva",
    variant="primary",
    command=save_handler
)

# Icon button
btn_icon = CustomButton(
    parent,
    text="â• Aggiungi",
    variant="accent"
)
```

---

### Sidebar

**Location**: `pymypersonalmap/gui/components/custom_sidebar.py`

Sidebar di navigazione con:
- **Branding**: Logo + titolo app
- **Navigation**: Menu items (Mappa, Markers, Etichette, etc.)
- **Quick Actions**: Bottoni azioni rapide
- **Bottom Section**: Impostazioni, Profilo

#### Struttura

```python
class Sidebar(ctk.CTkFrame):
    def __init__(self, master, width=280):
        self._create_branding()      # Logo + titolo
        self._create_navigation()    # Menu items
        self._create_quick_actions() # Bottoni rapidi
        self._create_bottom_section()# Settings/User
```

#### Menu Items

Definiti in `_create_navigation()`:
- ğŸ—ºï¸ Mappa
- ğŸ“ Markers
- ğŸ·ï¸ Etichette
- ğŸ›£ï¸ Percorsi
- ğŸ“Š Statistiche

---

### MapViewer

**Location**: `pymypersonalmap/gui/components/map_viewer.py`

Componente **CRITICO** per visualizzazione mappa interattiva.

#### Tecnologia

- **Folium**: Genera HTML con mappa Leaflet
- **tkinterweb.HtmlFrame**: Renderizza HTML in CustomTkinter
- **OpenStreetMap**: Tile provider

#### API

```python
from pymypersonalmap.gui.components import MapViewer

# Crea map viewer
map_viewer = MapViewer(
    parent,
    center=(45.4642, 9.1900),  # Lat, Lon
    zoom=12
)

# Aggiungi marker
map_viewer.add_marker(
    lat=45.4642,
    lon=9.1900,
    popup_text="Milano",
    icon_color="blue",
    tooltip="CittÃ  di Milano"
)

# Ricentra mappa
map_viewer.set_center(lat=41.9028, lon=12.4964, zoom=10)

# Pulisci markers
map_viewer.clear_markers()
```

#### Internals

```python
class MapViewer(ctk.CTkFrame):
    def __init__(self, ...):
        # WebView per HTML
        self.webview = HtmlFrame(self)

        # Mappa Folium
        self.map = folium.Map(...)

    def render(self):
        """Salva HTML â†’ temp file â†’ carica in WebView"""
        temp_file = tempfile.NamedTemporaryFile(suffix='.html')
        self.map.save(temp_file.name)
        self.webview.load_file(temp_file.name)
```

---

## Application Entry Point

### MyPersonalMapApp

**Location**: `pymypersonalmap/gui/app.py`

Classe principale applicazione.

#### Lifecycle

```python
class MyPersonalMapApp(ctk.CTk):
    def __init__(self):
        # 1. Window setup
        self.title("My Personal Map")
        self.geometry("1400x900")

        # 2. Theme init
        init_theme(mode="dark")

        # 3. Config manager
        self.config_mgr = ConfigManager()

        # 4. Backend manager
        self.backend = BackendManager()

        # 5. Check DB â†’ Wizard se necessario
        if not self.check_database_configured():
            self.show_setup_wizard()

        # 6. Start application
        self.start_application()

    def start_application(self):
        # Avvia backend
        self.backend.start()

        # Init DB tables
        self.initialize_database()

        # Load layout
        self.main_layout = MainLayout(self)
```

#### Metodi Chiave

- `check_database_configured()`: Verifica DB accessibile
- `show_setup_wizard()`: Lancia wizard setup
- `start_application()`: Avvia backend + GUI
- `initialize_database()`: Crea tabelle se necessario
- `on_closing()`: Cleanup alla chiusura

---

## Config Management

### ConfigManager

**Location**: `pymypersonalmap/gui/config_manager.py`

Gestisce configurazione OS-specific per eseguibili standalone.

#### User Data Directories

- **Windows**: `%LOCALAPPDATA%\MyPersonalMap`
- **macOS**: `~/Library/Application Support/MyPersonalMap`
- **Linux**: `~/.local/share/MyPersonalMap`

#### Struttura Directory

```
~/.local/share/MyPersonalMap/
â”œâ”€â”€ .env                    # Configurazione
â”œâ”€â”€ logs/                   # Application logs
â”œâ”€â”€ cache/                  # Cache files
â”œâ”€â”€ exports/                # Exported data
â””â”€â”€ mypersonalmap.db       # SQLite fallback
```

#### API

```python
from pymypersonalmap.gui.config_manager import ConfigManager

config_mgr = ConfigManager()

# Init config (crea .env se non esiste)
env_path = config_mgr.init_config()

# Get directories
logs_dir = config_mgr.get_logs_dir()
cache_dir = config_mgr.get_cache_dir()
exports_dir = config_mgr.get_exports_dir()

# Backup config
config_mgr.backup_config()

# Reset config
config_mgr.reset_config()
```

---

## Testing GUI

### Development Mode

```bash
# Avvia applicazione in development
cd /media/federicocalo/D/prj/myPersonalMap
source venv/bin/activate
python pymypersonalmap/gui/app.py
```

### Debug Mode

Abilita logging dettagliato in `app.py`:

```python
logging.basicConfig(
    level=logging.DEBUG,  # Cambia da INFO a DEBUG
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

### Hot Reload

Per sviluppo rapido componenti, usa test script:

```python
# test_component.py
import customtkinter as ctk
from pymypersonalmap.gui.theme import init_theme
from pymypersonalmap.gui.components import CustomButton

app = ctk.CTk()
init_theme("dark")

btn = CustomButton(app, text="Test", variant="primary")
btn.pack(pady=20)

app.mainloop()
```

---

## Best Practices

### 1. Separazione Concerns

- **Components**: UI pura, no business logic
- **Layouts**: Composizione components
- **App**: Orchestrazione, lifecycle management

### 2. Theme Consistency

Usa sempre variabili da `theme.py`:

```python
# âœ… GOOD
from pymypersonalmap.gui.theme import COLORS, SPACING
button.configure(fg_color=COLORS["primary"], padx=SPACING["md"])

# âŒ BAD
button.configure(fg_color="#4F46E5", padx=16)
```

### 3. Error Handling

Gestisci errori a livello app:

```python
try:
    self.backend.start()
except TimeoutError as e:
    self.show_error_and_exit(f"Backend failed: {e}")
```

### 4. Resource Cleanup

Cleanup risorse in destructor:

```python
class MapViewer:
    def __del__(self):
        # Cleanup temp HTML files
        if self.temp_file:
            Path(self.temp_file.name).unlink(missing_ok=True)
```

---

## Estensioni Future

### 1. Componenti Mancanti

Da implementare:
- `custom_card.py` - Container cards
- `custom_input.py` - Input fields con validazione
- `custom_modal.py` - Dialog/modals

### 2. Splash Screen

Schermata caricamento durante startup:

```python
class SplashScreen(ctk.CTkToplevel):
    def __init__(self):
        # Logo + progress bar
        # Mostra durante backend.start()
```

### 3. Settings Panel

Panel impostazioni:
- Theme toggle (light/dark)
- Database connection
- Geocoding provider
- Import/Export settings

### 4. Marker Dialog

Dialog per CRUD markers:
- Form inputs (nome, coordinate, descrizione)
- Label selector
- Geocoding search
- Preview sulla mappa

---

## Troubleshooting

### tkinterweb non Funziona

```bash
# Installa dipendenza
pip install tkinterweb==3.24.8

# Se errori su Linux, installa webkit
sudo apt install gir1.2-webkit2-4.0
```

### Mappa Non Renderizza

Verifica:
1. Folium installato: `pip install folium==0.15.1`
2. File temp accessibile: Check permissions
3. Console errors: Debug in `map_viewer.py`

### Theme Non Applicato

Verifica path tema:
```python
# In theme.py
THEME_PATH = Path(__file__).parent / "themes" / "mypersonalmap_theme.json"
print(f"Theme path: {THEME_PATH}")
print(f"Exists: {THEME_PATH.exists()}")
```

---

## Riferimenti

- [CustomTkinter Documentation](https://github.com/TomSchimansky/CustomTkinter)
- [Folium Documentation](https://python-visualization.github.io/folium/)
- [tkinterweb GitHub](https://github.com/Andereoo/TkinterWeb)
- Design System: `/DESIGN_SYSTEM.md`
- Architettura: `/doc/03. Architecture/01. Architecture.md`
