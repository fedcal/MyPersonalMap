# Setup Guide - My Personal Map

## Indice

1. [Requisiti di Sistema](#requisiti-di-sistema)
2. [Installazione Python e Dipendenze](#installazione-python-e-dipendenze)
3. [Installazione e Configurazione MySQL](#installazione-e-configurazione-mysql)
4. [Setup Ambiente di Sviluppo](#setup-ambiente-di-sviluppo)
5. [Configurazione Applicazione](#configurazione-applicazione)
6. [Inizializzazione Database](#inizializzazione-database)
7. [Avvio Applicazione](#avvio-applicazione)
8. [Troubleshooting](#troubleshooting)
9. [Deployment Produzione](#deployment-produzione)

---

## Requisiti di Sistema

### Hardware Minimo
- **CPU**: Dual-core 2.0 GHz o superiore
- **RAM**: 4 GB (8 GB raccomandato)
- **Spazio Disco**: 2 GB (500 MB app + 1.5 GB database)
- **Connessione Internet**: Richiesta per geocoding e tiles mappa

### Software
- **Sistema Operativo**:
  - Linux (Ubuntu 20.04+, Debian 11+, Fedora 35+)
  - macOS 11+ (Big Sur o superiore)
  - Windows 10/11
- **Python**: 3.9 o superiore (raccomandato 3.11+)
- **MySQL**: 8.0 o superiore
- **Git**: Per clonare il repository

---

## Installazione Python e Dipendenze

### Linux (Ubuntu/Debian)

```bash
# Aggiorna package list
sudo apt update

# Installa Python 3.11 e pip
sudo apt install python3.11 python3.11-venv python3-pip

# Installa dipendenze di sistema per librerie geospaziali
sudo apt install -y \
    libgdal-dev \
    libgeos-dev \
    libproj-dev \
    python3-dev \
    build-essential

# Verifica installazione
python3.11 --version
pip3 --version
```

### macOS

```bash
# Installa Homebrew se non presente
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Installa Python 3.11
brew install python@3.11

# Installa dipendenze geospaziali
brew install gdal geos proj

# Verifica installazione
python3.11 --version
```

### Windows

1. Scarica Python 3.11 da [python.org](https://www.python.org/downloads/)
2. Durante installazione, seleziona "Add Python to PATH"
3. Installa Microsoft C++ Build Tools:
   - Scarica da [Visual Studio](https://visualstudio.microsoft.com/downloads/)
   - Seleziona "Desktop development with C++"

4. Installa GDAL tramite binari precompilati:
```powershell
# Usa pip con wheel precompilati
pip install pipwin
pipwin install gdal
pipwin install fiona
```

---

## Installazione e Configurazione MySQL

### Linux (Ubuntu/Debian)

```bash
# Installa MySQL Server
sudo apt install mysql-server

# Avvia servizio MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# Esegui script sicurezza
sudo mysql_secure_installation
```

Rispondi alle domande:
- Set root password: **YES** (scegli password sicura)
- Remove anonymous users: **YES**
- Disallow root login remotely: **YES**
- Remove test database: **YES**
- Reload privilege tables: **YES**

### macOS

```bash
# Installa MySQL tramite Homebrew
brew install mysql

# Avvia servizio
brew services start mysql

# Configura sicurezza
mysql_secure_installation
```

### Windows

1. Scarica MySQL Installer da [mysql.com](https://dev.mysql.com/downloads/installer/)
2. Esegui installer e seleziona "Developer Default"
3. Configura root password durante setup
4. Verifica servizio avviato in Services

### Creazione Database

```bash
# Accedi a MySQL come root
mysql -u root -p

# Crea database
CREATE DATABASE mypersonalmap CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# Crea utente applicazione
CREATE USER 'mypersonalmap_user'@'localhost' IDENTIFIED BY 'secure_password_here';

# Assegna privilegi
GRANT ALL PRIVILEGES ON mypersonalmap.* TO 'mypersonalmap_user'@'localhost';

# Applica modifiche
FLUSH PRIVILEGES;

# Verifica creazione
SHOW DATABASES;

# Esci
EXIT;
```

### Verifica Supporto Spatial

```bash
mysql -u mypersonalmap_user -p mypersonalmap

# Test spatial types
SELECT ST_GeomFromText('POINT(12.4922 41.8902)', 4326) AS test_point;

# Dovrebbe mostrare risultato binario senza errori
EXIT;
```

---

## Setup Ambiente di Sviluppo

### 1. Clona Repository

```bash
# Clona progetto
git clone https://github.com/tuousername/myPersonalMap.git

# Entra nella directory
cd myPersonalMap
```

### 2. Crea Virtual Environment

```bash
# Crea virtual environment
python3.11 -m venv venv

# Attiva virtual environment
# Linux/macOS:
source venv/bin/activate

# Windows:
venv\Scripts\activate

# Verifica attivazione (dovresti vedere (venv) nel prompt)
which python  # Linux/macOS
where python  # Windows
```

### 3. Installa Dipendenze Python

```bash
# Aggiorna pip
pip install --upgrade pip

# Installa dipendenze dal requirements.txt
cd pymypersonalmap
pip install -r requirements.txt
```

**requirements.txt**:
```txt
# Web Framework
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-multipart==0.0.6

# Database
sqlalchemy==2.0.25
pymysql==1.1.0
alembic==1.13.1

# Geospatial
geopandas==0.14.2
shapely==2.0.2
fiona==1.9.5
geopy==2.4.1
folium==0.15.1
gpxpy==1.6.1

# Data Processing
pandas==2.1.4
numpy==1.26.3

# Authentication & Security
pyjwt==2.8.0
passlib[bcrypt]==1.7.4
python-jose[cryptography]==3.3.0

# Validation
pydantic==2.5.3
pydantic-settings==2.1.0

# Utilities
python-dotenv==1.0.0
requests==2.31.0
beautifulsoup4==4.12.2
lxml==5.1.0

# GUI (Desktop)
customtkinter==5.2.1
pillow==10.2.0

# Testing
pytest==7.4.4
pytest-asyncio==0.23.3
httpx==0.26.0

# Development
black==24.1.1
flake8==7.0.0
mypy==1.8.0
```

### 4. Verifica Installazione

```bash
# Test import librerie principali
python -c "import folium; import geopandas; import fastapi; print('All imports successful!')"
```

Se compaiono errori, vedi sezione [Troubleshooting](#troubleshooting).

---

## Configurazione Applicazione

### 1. File di Configurazione

Crea file `.env` nella root del progetto:

```bash
cd /path/to/myPersonalMap
touch .env
```

Modifica `.env` con editor:

```env
# Database Configuration
DATABASE_URL=mysql+pymysql://mypersonalmap_user:secure_password_here@localhost:3306/mypersonalmap

# Application Settings
APP_NAME=MyPersonalMap
APP_VERSION=1.0.0
DEBUG=true
LOG_LEVEL=INFO

# Security
SECRET_KEY=your-secret-key-min-32-characters-change-this-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=60
REFRESH_TOKEN_EXPIRE_DAYS=7

# API Settings
API_V1_PREFIX=/api/v1
ALLOWED_HOSTS=localhost,127.0.0.1
CORS_ORIGINS=http://localhost:3000,http://localhost:8080

# Geocoding
GEOCODING_PROVIDER=nominatim
GEOCODING_USER_AGENT=MyPersonalMap/1.0
# GOOGLE_MAPS_API_KEY=your-key-here  # Opzionale

# File Upload
MAX_UPLOAD_SIZE_MB=50
ALLOWED_IMPORT_FORMATS=gpx,kml,geojson,csv

# Server
HOST=0.0.0.0
PORT=8000
WORKERS=4
```

### 2. Genera Secret Key

```bash
# Genera secret key sicura
python -c "import secrets; print(secrets.token_urlsafe(32))"

# Copia output e incollalo in .env come SECRET_KEY
```

### 3. Struttura Directory

Verifica/crea struttura:

```bash
myPersonalMap/
├── pymypersonalmap/
│   ├── __init__.py
│   ├── main.py
│   ├── requirements.txt
│   ├── api/
│   │   ├── __init__.py
│   │   ├── routes/
│   │   │   ├── markers.py
│   │   │   ├── labels.py
│   │   │   ├── routes.py
│   │   │   └── auth.py
│   │   └── dependencies.py
│   ├── models/
│   │   ├── __init__.py
│   │   ├── marker.py
│   │   ├── label.py
│   │   └── user.py
│   ├── services/
│   │   ├── __init__.py
│   │   ├── marker_service.py
│   │   ├── geocoding_service.py
│   │   └── import_export_service.py
│   ├── database/
│   │   ├── __init__.py
│   │   ├── session.py
│   │   └── base.py
│   ├── gui/
│   │   ├── __init__.py
│   │   ├── main_window.py
│   │   └── components/
│   └── tests/
│       └── __init__.py
├── alembic/
│   ├── versions/
│   └── env.py
├── doc/
├── .env
├── .gitignore
├── README.md
└── alembic.ini
```

---

## Inizializzazione Database

### 1. Setup Alembic (Migrations)

```bash
# Inizializza Alembic (già fatto se clonato)
# alembic init alembic

# Configura alembic.ini
# Verifica che sqlalchemy.url punti al database
```

Modifica `alembic.ini`:
```ini
sqlalchemy.url = mysql+pymysql://mypersonalmap_user:secure_password_here@localhost:3306/mypersonalmap
```

### 2. Crea Schema Database

**Opzione A: Usando Alembic (Raccomandato)**

```bash
# Crea migration iniziale
alembic revision --autogenerate -m "Initial schema"

# Applica migration
alembic upgrade head

# Verifica
alembic current
```

**Opzione B: Script SQL Diretto**

```bash
# Esegui script SQL dal doc/04. Implementation/01. Database Design.md
mysql -u mypersonalmap_user -p mypersonalmap < scripts/init_schema.sql
```

### 3. Popola Dati Iniziali

```bash
# Script Python per labels di sistema
python scripts/seed_data.py
```

**scripts/seed_data.py**:
```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
import os
from dotenv import load_dotenv

load_dotenv()

engine = create_engine(os.getenv('DATABASE_URL'))
Session = sessionmaker(bind=engine)
session = Session()

# Labels di sistema
system_labels = [
    {'name': 'Urbex', 'color': '#8b4513', 'icon': 'building', 'is_system': True},
    {'name': 'Ristorante', 'color': '#ff4444', 'icon': 'utensils', 'is_system': True},
    {'name': 'Pizzeria', 'color': '#ff8c00', 'icon': 'pizza-slice', 'is_system': True},
    {'name': 'Fotografia', 'color': '#4444ff', 'icon': 'camera', 'is_system': True},
    {'name': 'Drone', 'color': '#00ccff', 'icon': 'helicopter', 'is_system': True},
    {'name': 'Natura', 'color': '#44ff44', 'icon': 'tree', 'is_system': True},
    {'name': 'Museo', 'color': '#9932cc', 'icon': 'landmark', 'is_system': True},
]

# Inserisci labels (usa i tuoi modelli SQLAlchemy)
# ...

session.commit()
print("Database seeded successfully!")
```

### 4. Verifica Database

```bash
mysql -u mypersonalmap_user -p mypersonalmap

# Verifica tabelle
SHOW TABLES;

# Verifica labels
SELECT * FROM labels;

EXIT;
```

---

## Avvio Applicazione

### Modalità Sviluppo

#### Backend API

```bash
# Attiva virtual environment
source venv/bin/activate  # Linux/macOS
# venv\Scripts\activate  # Windows

# Avvia FastAPI con reload
cd pymypersonalmap
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# Output dovrebbe mostrare:
# INFO:     Uvicorn running on http://0.0.0.0:8000
# INFO:     Application startup complete.
```

Verifica API:
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health check: http://localhost:8000/api/v1/health

#### GUI Desktop

```bash
# Avvia interfaccia grafica
python gui/main_window.py

# Oppure
python -m pymypersonalmap.gui.main_window
```

### Modalità Produzione

```bash
# Disattiva debug in .env
DEBUG=false

# Avvia con Gunicorn (più worker)
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000

# Oppure direttamente con Uvicorn
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

---

## Troubleshooting

### Problema: Errore Import GDAL/Fiona

**Linux**:
```bash
# Reinstalla con bindings corretti
sudo apt install gdal-bin libgdal-dev
pip install GDAL==$(gdal-config --version)
pip install fiona --no-binary fiona
```

**Windows**:
```bash
# Usa wheel precompilati
pip install pipwin
pipwin install gdal
pipwin install fiona
```

**macOS**:
```bash
# Reinstalla con Homebrew
brew reinstall gdal
pip install --upgrade --force-reinstall fiona
```

### Problema: MySQL Connection Failed

```bash
# Verifica servizio MySQL attivo
sudo systemctl status mysql  # Linux
brew services list  # macOS

# Test connessione
mysql -u mypersonalmap_user -p -h localhost

# Verifica .env DATABASE_URL corretto
cat .env | grep DATABASE_URL
```

### Problema: ModuleNotFoundError

```bash
# Verifica virtual environment attivo
which python  # Dovrebbe puntare a venv/bin/python

# Reinstalla requirements
pip install -r requirements.txt --upgrade
```

### Problema: Port Already in Use

```bash
# Trova processo su porta 8000
# Linux/macOS:
lsof -i :8000
kill -9 <PID>

# Windows:
netstat -ano | findstr :8000
taskkill /PID <PID> /F

# Oppure usa porta diversa
uvicorn main:app --port 8001
```

### Problema: Geocoding Rate Limit

```bash
# Nominatim richiede 1 secondo tra richieste
# Modifica in .env:
GEOCODING_RATE_LIMIT_SECONDS=1

# Oppure usa provider alternativo
GEOCODING_PROVIDER=google
GOOGLE_MAPS_API_KEY=your-api-key
```

---

## Deployment Produzione

### Docker Deployment (Raccomandato)

**Dockerfile**:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# Installa dipendenze sistema
RUN apt-get update && apt-get install -y \
    libgdal-dev \
    libgeos-dev \
    && rm -rf /var/lib/apt/lists/*

# Copia requirements
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia applicazione
COPY . .

# Esponi porta
EXPOSE 8000

# Comando avvio
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**docker-compose.yml**:
```yaml
version: '3.8'

services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: mypersonalmap
      MYSQL_USER: mypersonalmap_user
      MYSQL_PASSWORD: secure_password
      MYSQL_ROOT_PASSWORD: root_password
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: mysql+pymysql://mypersonalmap_user:secure_password@db:3306/mypersonalmap
    depends_on:
      - db
    volumes:
      - ./uploads:/app/uploads

volumes:
  mysql_data:
```

Avvio:
```bash
docker-compose up -d
```

### Systemd Service (Linux)

**/etc/systemd/system/mypersonalmap.service**:
```ini
[Unit]
Description=MyPersonalMap API
After=network.target mysql.service

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/opt/mypersonalmap
Environment="PATH=/opt/mypersonalmap/venv/bin"
ExecStart=/opt/mypersonalmap/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always

[Install]
WantedBy=multi-user.target
```

Comandi:
```bash
sudo systemctl enable mypersonalmap
sudo systemctl start mypersonalmap
sudo systemctl status mypersonalmap
```

### Nginx Reverse Proxy

**/etc/nginx/sites-available/mypersonalmap**:
```nginx
server {
    listen 80;
    server_name mypersonalmap.example.com;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /static {
        alias /opt/mypersonalmap/static;
    }
}
```

Attivazione:
```bash
sudo ln -s /etc/nginx/sites-available/mypersonalmap /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### SSL con Let's Encrypt

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d mypersonalmap.example.com
```

---

## Testing

```bash
# Unit tests
pytest

# Con coverage
pytest --cov=pymypersonalmap

# Test specifico
pytest tests/test_marker_service.py

# Verbose
pytest -v
```

---

## Backup e Restore

### Backup Database

```bash
# Backup completo
mysqldump -u mypersonalmap_user -p mypersonalmap > backup_$(date +%Y%m%d).sql

# Backup automatico (cron)
0 2 * * * /usr/bin/mysqldump -u user -p'password' mypersonalmap > /backups/mypersonalmap_$(date +\%Y\%m\%d).sql
```

### Restore Database

```bash
mysql -u mypersonalmap_user -p mypersonalmap < backup_20251213.sql
```

---

## Prossimi Passi

1. ✅ Setup completato
2. Leggi [02. User Guide](../05.%20Reference/02.%20User%20Guide.md) per utilizzo
3. Consulta [02. API Documentation](../04.%20Implementation/02.%20API%20Documentation.md) per sviluppo
4. Vedi [01. Architecture](../03.%20Architecture/01.%20Architecture.md) per comprendere struttura

---

**Supporto**: Per problemi, apri issue su GitHub o consulta la documentazione completa.
